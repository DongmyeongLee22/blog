---
title: 데이터 중심 애플리케이션 설계 Ch 8. 분산 시스템의 골칫거리
date: 2021-12-16 22:23
sub: true
img: 
    - data-intensive.jpg
tags: 
    - Design
---

## 결함과 부분 장애

분산 시스템에서 시스템이 커질수록 구성 요소 중 하나가 고장날 가능성도 높다. 수천 개의 노드가 있는 시스템은 항상 뭔가 고장난 상태라고 가정하는게 합리적이다.

소프트웨어 운영자로서 결함이 발생하면 소프트웨어가 어떻게 동작하는지 알아야 한다. 최선의 상황을 바라기만 하는 것은 현명하지 못하다. 분산 시스템에서 의심, 비관주의, 편집증은 그 값어치를 한다.

분산 시스템이 동작하게 만드려면 부분 장애 가능성을 항상 받아들이고 소프트웨어에 내결함성 메커니즘을 넣어야 한다. 즉, **신뢰성 없는 구성 요소를 사용해 신뢰성 있는 시스템을 구축해야 한다.**

### 신뢰성 없는 구성 요소를 사용해 신뢰성 있는 시스템 구축한 예
- 이러한 시스템의 대표적인 예로 신뢰성 없는 IP(Internet Protocol)위에 신뢰성 높은 TCP(Transimission Control Protocal)를 두어 패킷 손실 시 재전송하고 순서에 맞춰 재조립되도록 보장해준다.

## 신뢰성 없는 네트워크
여기서 다루는 분산 시스템은 **비공유 시스템**, 즉 네트워크로 연결된 다수의 장비로 네트워크가 이 장비들의 유일한 통신 수단이다.

인터넷과 데이터센터 내부 이더넷은 비동기 패킷 네트워크다. 즉, **노드는 다른 노드로 메시지(패킷)을 보낼 수 있지만 네트워크는 메시지가 언제 도착할 것인지 보장하지 않는다.**

**요청을 보내고 응답을 기다릴 때 잘못될 수 있는 경우는 많다.**
1. 요청이 손실됨(네트워크 케이블 뽑힘)
2. 요청이 큐에서 대기하다가 나중에 전송됨(네트워크나 수신자에 과부하)
3. 원격 노드에 장애(노드가 죽음)
4. 원격 노드의 일시적인 중지(GC)
5. 원격 노드가 요청을 처리했지만 응답이 네트워크에서 손실
6. 원격 노드가 요청을 처리했지만 응답이 지연

**전송 측은 패킷이 전송됐는지 아닌지조차 구별할 수 없다. 유일한 정보는 응답을 아직 받지 못했다는 것이다.**
- 이런 문제를 다루는 대표적인 방법은 `타임아웃`을 활용하여 응답이 도착하지 않았음을 가정한다.

### 현실의 네트워크 결함
- 누구도 네트워크 문제에서 자유로울 수 없다. 상어가 해저 케이블을 물어뜯어서 손상시키기도 한다.
- 시스템 환경에서 네트워크 결함이 드물더라도 **일어날 수 있다**는 사실은 소프트웨어가 이를 처리할 수 있어야 한다는 뜻이다.

#### 결함 감지
- 많은 시스템은 결함 있는 노드를 자동으로 감지할 수 있어야 한다.
  - 로드 밸런서는 죽은 노드로 요청을 보내면 안된다.
  - 단일 리더 복제를 사용하는 분산 데이터베이스 시스템에서 리더에 장애가 발생하면 팔로워 중 하나가 리더로 승격돼야 한다.
- 하지만, **불행하게도 네트워크에 관한 불확실성 때문에 노드가 동작 중인지 아닌지 구별하기 어렵다.**
  - TCP가 패킷이 전달됐다는 확인 응답을 했더라도 애플리케이션이 그것을 처리하기 전에 죽을 수도 있다.
  - 몇 번 재시도를 해 보고 타임아웃이 게속 발생하면 마침내 노드가 죽었다고 선언할 수 있다.

### 타임아웃과 기약 없는 지연
- 타임아웃으로 결함을 감지할 수 있다면 타임아웃은 얼마나 길어야 할까?
- 타임아웃이 길면 노드가 죽었다고 선언될 떄 까지 기다리는 시간이 길어진다.
- 타임아웃이 짧은면 결함을 빨리 발견하지만 노드가 과부화로 인해 일시적으로 느려졌을때에도 죽었다고 잘못 판단할 위험이 있다.
  - **성급하게 노드가 죽었다고 선언하면 같은 동작이 여러번 수행될 수 있다.**
  - 만약 과부하로 인해 노드가 죽었다고 잘못 판단하는 경우 리밸런싱 과정은 더욱 더 상태를 악화시킬 수 있다.
- **고정된 타임아웃을 설정하는 대신 시스템이 지속적으로 응답 시간과 그들의 변동성을 측정해 유동적으로 타임아웃을 조절하게 하는 것이 좋다.**

#### TCP vs UDP
- TCP는 패킷이 손실되면 자동으로 재전송을 시도한다.
  - 애플리케이션에서는 이를 모르지만 그 결과로 생긴 지연으로 판단할 수 있다.
- UDP는 흐름 제어를 하지 않고 손실된 패킷을 재전송하지 않는다. 네트워크 지연이 크게 변하게 하는 원인 중 일부를 제거한다.
  - **그러므로, UDP는 지연된 데이터의 가치가 없는 상황에 선택하면 좋다.**
  - 화상 회의나 인터넷 전화는 지연된 데이터의 가치가 없기 때문에 UDP를 사용한다.

### 동기 네트워크 vs 비동기 네트워크
- 동기식 네트워크의 대표적인 예시는 전화 네트워크이다. 전화 네트워크는 극단적인 신뢰성을 가진다.
  - 전화 네트워크에서 통화할 때는 회선(circuit)이 만들어지며 통화가 끝날 때 까지 유지된다.
  - 동기식 네트워크는 이미 특정 공간만큼의 회선이 할당되어 있기 때문에 데이터가 여러 라우터를 거치더라도 큐 대기 문제를 겪지 않는다. 
- 동기식 네트워크와 같이 회선을 할당하는 방식은 통화와 같은 초당 전송하는 비트 수가 고정되어 있는 경우 회선이 적절하지만 **웹 페이지 요청과 같이 순간적으로 몰릴 수 있는 데이터 전송**에 효율적이지 못하다.
- 비동기 네트워크의 대표적인 예시는 인터넷이다. 인터넷은 대역폭을 **동적으로 공유한다.**
  - 전송적은 가능하면 빨리 패킷을 보내기 위해 서러 밀치며 네트워크 스위치가 빈번하게 어떤 패킷을 보낼지(대역폭을 할당할지) 결정한다. 이 방법은 **큐 대기가 생길 수 있지만 선로를 효율적으로 이용할 수 있다.** 
  - 이 방식은 자원을 최대한 효율적으로 사용한다. 하지만 지연이라는 큰 변동이 생기게 된다.
  - 통화와 같이 회선을 점유하는 방식은 해당 회선이 점유한 대역폭만큼을 계속 보유하기 때문에 실제 대역폭 만큼 데이터를 전송하지 않더라도 대역폭은 게속 할당된다. 대신 지연의 변동은 적다.

